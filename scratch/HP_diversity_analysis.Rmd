---
title: "HP_diversity_analysis"
output: html_document
date: "2025-04-18"
---


### Load in packages

```{r, warning=FALSE}
library(tidyverse)
library("plyr")
library(dplyr)
library(ggplot2)
library(readr)
library(ggrepel)

library("phyloseq")
```




### Load in the Household Project dataset

```{r}
household_data <- read.table("C:/Users/anaes/OneDrive/UCI_Spring25/rotation/e0026-e0029-e0030.txt", header = TRUE)

# Divide dataset into separate tables by experiment. Filter out unnecessary columns

e0026 <- filter(household_data, str_detect(household_data$sample, "e0026")) %>% 
select(sample, biosample1, experiment, passage, OTU, count, replicate, relAbundance, Phylum, Family, Genus)

e0026_clean <- e0026 %>%
  mutate(
    subject = str_sub(biosample1, 1, -5),    # remove last 4 characters
    day = str_sub(biosample1, -3),
    household = str_sub(biosample1, 1, -6),
    antibiotic = if_else(str_sub(biosample1, 3, 3) == "A", 1, 0)
  )

e0026_passage8 <- e0026_clean %>% 
  filter(passage == 8)

e0026_day1 <- e0026_clean %>%  filter(str_detect(biosample1, "001") | str_detect(biosample1, "002") | str_detect(biosample1, "003") | str_detect(biosample1, "022")) %>% 
mutate(day = "001")

e0026_day29 <- e0026_clean %>%   filter(str_detect(biosample1, "029") | str_detect(biosample1, "028") | str_detect(biosample1, "027")) %>% 
mutate(day = "029")

e0026_day36 <- e0026_clean %>%  filter(str_detect(biosample1, "036")) %>% 
mutate(day = "036")

e0026_day64 <- e0026_clean %>%  filter(str_detect(biosample1, "064")) %>% 
mutate(day = "064")


```


### Using Phyloseq to calculate diversity statistics


```{r}
data <- readRDS("../data/ps_all.rds")

hp_data_clean <- prune_taxa(taxa_sums(data) > 0, data)

e0026_obj <- subset_samples(hp_data_clean, experiment == "e0026")

OUTDIR <- "./"

```



### Get alpha diversity metrics (ONLY RUN ONCE)

```{r}
# Calculate alpha diversity.
calculateAlphaDiversity <- function(data) {

  # Use the estimate_richness function to calculate
  # an array of alpha-diversity statistics.
  alphaRaw <- estimate_richness(data, split=TRUE)
  # Add the sample names.
  alphaRaw$sample <- rownames(alphaRaw)
  # Calculate the Shannon effective number of species.
  alphaRaw <- alphaRaw %>%
	mutate(ShannonEffectiveSpecies=exp(Shannon))
  # Tidy the dataframe.
  alpha <- alphaRaw %>%
	mutate(sample=gsub("\\.","-",sample)) %>%
	pivot_longer(-sample, names_to="alphaStat", values_to="value")
}

alpha_diversity <- calculateAlphaDiversity(e0026_obj)
write_delim(alpha_diversity, paste0(OUTDIR, "alpha_diversity.txt"))

```


# Get beta diversity metrics (ONLY RUN ONCE)

```{r}
# List the distance-calculation methods to be used.
distMethods <- c("jsd","bray","jaccard")

# Write a function to calculate a distance matrix using the specified method
# and convert the data into tidy format.
calculateBeta <- function(data, distMethod) {
  # Calculate the distance matrix using the specified method.
  betaRaw <- distance(data, method=distMethod)
 
  # Convert distance matrix to a dataframe.
  beta <- as.matrix(betaRaw)
  beta <- as.data.frame(beta)
  beta$sample1 <- rownames(beta)
  # Tidy the dataframe.
  beta <- beta %>%
	pivot_longer(-sample1, names_to="sample2", values_to="value")
  beta <- beta %>%
	filter(sample1 != sample2) %>%
	mutate(method=distMethod)
}

# Calculate the distance matrix for all of the specified methods on the species abundances.
# Combine the distance matrices for all methods.
betaSpecies <- do.call(rbind, lapply(distMethods, function(distMethod) {
  print(distMethod)
  calculateBeta(e0026_obj, distMethod)
}))
# Export the distance matrix generated for all of the sample pairs
# using all of the specified methods.
write_delim(betaSpecies, paste0(OUTDIR, "speciesBeta.txt.gz"))

```



```{r}

# Define a function to extract passage information from raw sample ID

extract_passage <- function(x) {
  ifelse(
    str_detect(x, "-mix-"),
    NA_character_,
    str_extract(x, "-[A-Z]-[08]-[A-Z0-9]+") %>%
      str_extract("[08]")
  )
}
```


### Change in Alpha Diversity through Time

```{r}

combined_data <- e0026_day29

# Read in alpha diversity file
alpha_diversity <- read_delim("./alpha_diversity.txt")
data(alpha_diversity)


# Only consider samples contained within combined data
valid_samples <- combined_data %>%
  distinct(sample) %>%
  pull(sample)

# Pivot to have each statistic as its own column
alpha_diversity_wide <- alpha_diversity %>%
  filter(alphaStat %in% c("Shannon", "Chao1")) %>%
  select(sample, alphaStat, value) %>%
  pivot_wider(names_from = alphaStat, values_from = value)

# Add a column with altered sample ID
combined_data_alpha <- combined_data %>%
  distinct(sample, biosample1, day, subject, antibiotic)%>%
  mutate(xsample = paste0("X", sample))

# Left join be that sample ID
e0026_alpha <- combined_data_alpha %>%
  left_join(alpha_diversity_wide, by = c("xsample" = "sample"))

# Add day, antibiotic, and passage information
e0026_alpha <- e0026_alpha %>%
  mutate(
    day = factor(day, levels = sort(unique(day))),
    antibiotic = factor(antibiotic, levels = c(0, 1), labels = c("No", "Yes")),
    passage = extract_passage(xsample)
  )


```



```{r}
alpha_time <- ggplot(
  e0026_alpha,
  aes(x = day, y = Shannon, fill = antibiotic)
) +
  geom_boxplot(
    position = position_dodge(width = 0.75),
    width = 0.6,
    alpha = 0.9,
    size = 1
  )  +
  geom_jitter(
    color = "black",
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
    shape = 21,
    stroke = 0.3,
    size = 1.5,
    alpha = 0.8
  ) +
  labs(
    title = "Change in Alpha Diversity Pre- and Post Abx",
    x = "Day",
    y = "Alpha Diversity",
    fill = "Antibiotic"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

alpha_time
```

### Change in Beta Diversity through Time

```{r}

combined_data <- bind_rows(e0026_day1, e0026_day29, e0026_day36, e0026_day64)


beta_diversity <- read_delim("./speciesBeta.txt.gz")
data(beta_diversity)


beta_diversity_wide <- beta_diversity %>%
  select(sample1, sample2, method, value) %>%
  pivot_wider(names_from = method, values_from = value)

# # Left join by sample1 ID, rename to sample1's variable
# e0026_beta_1 <- beta_diversity_wide %>%
#   left_join(combined_data, by = c("sample1" = "sample")) %>%
#   dplyr::rename(
#     day1 = day,
#     subject1 = subject,
#     antibiotic1 = antibiotic
#   )
# 
# e0026_beta_1 %>%
#   select(sample1, day, subject, antibiotic) %>%
#   head()


# # Left join again by sample2 ID and rename to sample2's variables
# e0026_beta_2 <- e0026_beta_1 %>% 
#   left_join(combined_data, by = c("sample2" = "sample")) %>% 
#   dplyr::rename("day" = "day2", "subject" = "subject2", "antibiotic" = "antibiotic2") %>% 
#   mutate(passage1 = extract_passage(sample1),
#          passage2 = extract_passage(sample2))

```




```{r}


# ensure uniqueness in combined_data
combined_data_clean <- combined_data %>%
  distinct(sample, .keep_all = TRUE)

# join sample1 metadata and check
e0026_beta_1 <- beta_diversity_wide %>%
  left_join(combined_data_clean, by = c("sample1" = "sample"))



# if the columns exist, rename them
if (all(c("day", "subject", "antibiotic") %in% names(e0026_beta_1))) {
  e0026_beta_1 <- e0026_beta_1 %>%
    dplyr::rename(
      day1 = day,
      subject1 = subject,
      antibiotic1 = antibiotic
    )
} else {
  stop("Expected columns not found after join on sample1.")
}

# Join sample2 metadata
e0026_beta <- e0026_beta_1 %>%
  left_join(combined_data_clean, by = c("sample2" = "sample"))



# Rename second set
if (all(c("day", "subject", "antibiotic") %in% names(e0026_beta))) {
  e0026_beta <- e0026_beta %>%
    dplyr::rename(
      day2 = day,
      subject2 = subject,
      antibiotic2 = antibiotic
    )
} else {
  stop("Expected columns not found after join on sample2.")
}

# Add passage extraction
e0026_beta <- e0026_beta %>%
  mutate(
    passage1 = extract_passage(sample1),
    passage2 = extract_passage(sample2)
  )


```


One plot I could make is a box plot of the JSD between communities from the same subject at day 1 and 29, versus the JSD between communities from the same subject at days 29 and 36.
The question that this is answering: how much of an impact does the antibiotic have on community composition, compared to the normal level of variation that we see in the absence of antibiotics

```{r}

# Filter for only day combinations of interest. Maybe make a new column that has the combinations and from there decide which ones to keep.

e0026_beta_clean <- e0026_beta %>%
  mutate(day_pair = paste(day1, day2, sep = "_")) %>% 
  filter(subject1 == subject2 & day1 != day2 & passage1 == 8 & passage2 == 8 & day_pair %in% c("001_029", "029_036"))


ggplot(
  e0026_beta_clean,
  aes(x = day_pair, y = jsd)
) +
  geom_boxplot(
    position = position_dodge(width = 0.75),
    width = 0.6,
    alpha = 0.9,
    size = 1
  )  +
  geom_jitter(
  color = "black",
  position = position_jitter(width = 0.2),
  shape = 21,
  stroke = 0.3,
  size = 1.5,
  alpha = 0.8
)+
  labs(
    title = "Divergence Across Samples Pre and Post Abx",
    x = "Day Pair",
    y = "Jensen-Shannon Divergence"
  )  +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```




Compare the average distance (i.e. JSD) between two in vivo communities (passage 0), compared to two in vitro communities (passage 8).


```{r}

# Extract passage number (0 or 8)

jsd_p0p8 <- e0026_beta %>%
  # mutate(
  #   passage1 = extract_passage(sample1),
  #   passage2 = extract_passage(sample2)
  # )%>%
  # # remove rows where either passage is NA or mismatched
  filter(!is.na(passage1), !is.na(passage2), passage1 == passage2, day1 == "029", day2 == "029")
  


```




```{r}

ggplot(jsd_p0p8, aes(x = factor(passage1), y = jsd, fill = factor(passage1))) +
  geom_violin(width = 0.6, alpha = 0.85) +
  labs(
    title = "In Vivo vs In Vitro Community JSD (Within Passage)",
    x = "Passage",
    y = "Jensen-Shannon Divergence",
    fill = "Passage"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")

```




