---
title: "HP_diversity_analysis"
output: html_document
date: "2025-04-18"
---


### Load in packages

```{r, warning=FALSE}
library(tidyverse)
library("plyr")
library(dplyr)
library(ggplot2)
library(readr)
library(ggrepel)

library("phyloseq")
```




### Load in the Household Project dataset

```{r}
household_data <- read.table("C:/Users/anaes/OneDrive/UCI_Spring25/rotation/e0026-e0029-e0030.txt", header = TRUE)

# Divide dataset into separate tables by experiment. Filter out unnecessary columns

e0026 <- filter(household_data, str_detect(household_data$sample, "e0026")) %>% 
select(sample, biosample1, experiment, passage, OTU, count, replicate, relAbundance, Phylum, Family, Genus)

e0026_clean <- e0026 %>%
  mutate(
    subject = str_sub(biosample1, 1, -5),    # remove last 4 characters
    day = str_sub(biosample1, -3),
    household = str_sub(biosample1, 1, -6),
    antibiotic = if_else(str_sub(biosample1, 3, 3) == "A", 1, 0)
  )

e0026_passage8 <- e0026_clean %>% 
  filter(passage == 8)

e0026_day1 <- e0026_clean %>%  filter(str_detect(biosample1, "001") | str_detect(biosample1, "002") | str_detect(biosample1, "003") | str_detect(biosample1, "022")) %>% 
mutate(day = "001")

e0026_day29 <- e0026_clean %>%   filter(str_detect(biosample1, "029") | str_detect(biosample1, "028") | str_detect(biosample1, "027")) %>% 
mutate(day = "029")

e0026_day36 <- e0026_clean %>%  filter(str_detect(biosample1, "036")) %>% 
mutate(day = "036")

e0026_day64 <- e0026_clean %>%  filter(str_detect(biosample1, "064")) %>% 
mutate(day = "064")


```


### Using Phyloseq to calculate diversity statistics


```{r}
data <- readRDS("../data/ps_all.rds")

hp_data_clean <- prune_taxa(taxa_sums(data) > 0, data)

e0026_obj <- subset_samples(hp_data_clean, experiment == "e0026")

OUTDIR <- "./"

```



### Get alpha diversity metrics (ONLY RUN ONCE)

```{r}
# Calculate alpha diversity.
calculateAlphaDiversity <- function(data) {

  # Use the estimate_richness function to calculate
  # an array of alpha-diversity statistics.
  alphaRaw <- estimate_richness(data, split=TRUE)
  # Add the sample names.
  alphaRaw$sample <- rownames(alphaRaw)
  # Calculate the Shannon effective number of species.
  alphaRaw <- alphaRaw %>%
	mutate(ShannonEffectiveSpecies=exp(Shannon))
  # Tidy the dataframe.
  alpha <- alphaRaw %>%
	mutate(sample=gsub("\\.","-",sample)) %>%
	pivot_longer(-sample, names_to="alphaStat", values_to="value")
}

alpha_diversity <- calculateAlphaDiversity(e0026_obj)
write_delim(alpha_diversity, paste0(OUTDIR, "alpha_diversity.txt"))

```


# Get beta diversity metrics (ONLY RUN ONCE)

```{r}
# List the distance-calculation methods to be used.
distMethods <- c("jsd","bray","jaccard")

# Write a function to calculate a distance matrix using the specified method
# and convert the data into tidy format.
calculateBeta <- function(data, distMethod) {
  # Calculate the distance matrix using the specified method.
  betaRaw <- distance(data, method=distMethod)
 
  # Convert distance matrix to a dataframe.
  beta <- as.matrix(betaRaw)
  beta <- as.data.frame(beta)
  beta$sample1 <- rownames(beta)
  # Tidy the dataframe.
  beta <- beta %>%
	pivot_longer(-sample1, names_to="sample2", values_to="value")
  beta <- beta %>%
	filter(sample1 != sample2) %>%
	mutate(method=distMethod)
}

# Calculate the distance matrix for all of the specified methods on the species abundances.
# Combine the distance matrices for all methods.
betaSpecies <- do.call(rbind, lapply(distMethods, function(distMethod) {
  print(distMethod)
  calculateBeta(e0026_obj, distMethod)
}))
# Export the distance matrix generated for all of the sample pairs
# using all of the specified methods.
write_delim(betaSpecies, paste0(OUTDIR, "speciesBeta.txt.gz"))

```



### Change in Alpha Diversity through Time

```{r}


combined_data <- bind_rows(e0026_day1, e0026_day29, e0026_day36, e0026_day64)


alpha_diversity <- read_delim("./alpha_diversity.txt")
data(alpha_diversity)

valid_samples <- combined_data %>%
  distinct(sample) %>%
  pull(sample)

alpha_diversity_wide <- alpha_diversity %>%
  filter(alphaStat %in% c("Shannon", "Chao1")) %>%
  select(sample, alphaStat, value) %>%
  pivot_wider(names_from = alphaStat, values_from = value)

combined_data_alpha <- combined_data %>%
  distinct(sample, biosample1, day, subject, antibiotic)%>%
  mutate(xsample = paste0("X", sample))


e0026_alpha <- combined_data_alpha %>%
  left_join(alpha_diversity_wide, by = c("xsample" = "sample"))


e0026_alpha <- e0026_alpha %>%
  mutate(
    day = factor(day, levels = sort(unique(day))),
    antibiotic = factor(antibiotic, levels = c(0, 1), labels = c("No", "Yes"))
  )


```



```{r}
alpha_time <- ggplot(
  e0026_alpha,
  aes(x = day, y = Shannon, fill = antibiotic)
) +
  geom_boxplot(
    position = position_dodge(width = 0.75),
    width = 0.6,
    alpha = 0.9,
    size = 1
  )  +
  geom_jitter(
    color = "black",
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
    shape = 21,
    stroke = 0.3,
    size = 1.5,
    alpha = 0.8
  ) +
  labs(
    title = "Change in Alpha Diversity Pre- and Post Abx",
    x = "Day",
    y = "Alpha Diversity",
    fill = "Antibiotic"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

alpha_time
```

### Change in Beta Diversity through Time

```{r}

combined_data <- bind_rows(e0026_day1, e0026_day29, e0026_day36, e0026_day64)


beta_diversity <- read_delim("./speciesBeta.txt.gz")
data(beta_diversity)


beta_diversity_wide <- beta_diversity %>%
  select(sample1, sample2, method, value) %>%
  pivot_wider(names_from = method, values_from = value)

combined_data_beta <- combined_data %>%
  distinct(sample, day, subject, antibiotic)


```


Compare the average distance (i.e. JSD) between two in vivo communities (passage 0), compared to two in vitro communities (passage 8).


```{r}

# Extract passage number (0 or 8) using more flexible regex
extract_passage <- function(x) {
  str_extract(x, "-[A-Z]-[08]-[A-Z0-9]+") %>%
    str_extract("[08]")  # extract just the 0 or 8
}

beta_diversity_wide <- beta_diversity_wide%>%
  mutate(
    passage1 = extract_passage(sample1),
    passage2 = extract_passage(sample2)
  )%>%
  # remove rows where either passage is NA or mismatched
  filter(!is.na(passage1), !is.na(passage2), passage1 == passage2)


```



```{r}

# avg_jsd_summary <- beta_diversity_wide %>%
#   group_by(passage1) %>%
#   summarise(
#     mean_JSD = mean(jsd, na.rm = TRUE),
#     sd_JSD = sd(jsd, na.rm = TRUE),
#     n = n(),
#     .groups = "drop"
#   )


ggplot(beta_diversity_wide, aes(x = factor(passage1), y = jsd, fill = factor(passage1))) +
  geom_boxplot(width = 0.6, alpha = 0.85) +
  labs(
    title = "In Vivo vs In Vitro Community JSD (Within Passage)",
    x = "Passage",
    y = "Jensen-Shannon Divergence",
    fill = "Passage"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")

```

One plot I could make is a box plot of the JSD between communities from the same subject at day 1 and 29, versus the JSD between communities from the same subject at days 29 and 36.
The question that this is answering: how much of an impact does the antibiotic have on community composition, compared to the normal level of variation that we see in the absence of antibiotics


```{r}




```

